name: Update UFC Dataset

on:
  schedule:
    - cron: "0 0 1 * *"
  workflow_dispatch:
    inputs:
      jobs_to_run:
        description: "Select the jobs to run"
        required: true
        type: choice
        options:
          - all
          - upload-only
        default: all

jobs:
  update:
    if: github.event == 'schedule' || github.event.inputs.jobs_to_run == 'all'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.13"

      - name: Install dependencies + Kaggle CLI
        run: |
          pip install -r requirements.txt

      - name: Run pipeline
        run: python main.py

      - name: Create zip files
        run: |
          zip -jr "upload_ready/data.zip" data/
          zip -jr "upload_ready/raw_data.zip" raw_data/

      - name: Upload artifact for the upload
        uses: actions/upload-artifact@v4
        with:
          name: kaggle-dataset
          path: upload_ready/
          retention-days: 1

      - name: Commit and push changes
        run: |
          git config --local user.email "ameen_alibi@proton.me"
          git config --local user.name "ameen-alibi"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git add data/*.csv raw_data/*.csv upload_ready
          git diff --staged --quiet || git commit -m "Auto-update: Dataset updated on $(date '+%Y-%m-%d')"
          git push origin HEAD:${{github.ref_name}}

  upload:
    needs: update
    if: always() && (github.event_name == 'schedule' ||github.event.inputs.jobs_to_run == 'all' ||github.event.inputs.jobs_to_run == 'upload-only')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download files from the artifact
        if: github.event.inputs.jobs_to_run != 'upload-only'
        uses: actions/download-artifact@v4
        with:
          name: kaggle-upload-files
          path: upload_ready/

      - name: Configure Kaggle credentials
        run: |
          mkdir -p ~/.kaggle
          echo "{\"username\":\"${{ secrets.KAGGLE_USERNAME }}\",\"key\":\"${{ secrets.KAGGLE_KEY }}\"}" > ~/.kaggle/kaggle.json
          chmod 600 ~/.kaggle/kaggle.json

      - name: Download Kaggle CLI
        run: pip install kaggle

      - name: Verify files
        run: ls -lah upload_ready/

      - name: Upload new version
        run: |
          TODAY=$(date '+%Y-%m-%d')
          kaggle datasets version -p upload_ready -m "Automated update â€” ${TODAY}"
